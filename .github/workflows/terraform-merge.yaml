name: Terraform Apply on Merge

on:
  push:
    branches: [main]

permissions:
  contents: read
  actions: read
  id-token: write

env:
  TF_IN_AUTOMATION: "true"
  TERRAFORM_VERSION: "1.9.8"
  TF_PLUGIN_CACHE_DIR: /home/runner/.terraform.d/plugin-cache
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TF_VAR_region: ${{ secrets.AWS_REGION }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main at the pushed commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Locate merged PR for this commit
        id: pr
        shell: bash
        run: |
          set -euo pipefail

          owner_repo="${{ github.repository }}"
          sha="${{ github.sha }}"

          # PRs associated with the commit; pick the first that is merged
          prs_json="$(gh api \
            -H 'Accept: application/vnd.github+json' \
            "repos/${owner_repo}/commits/${sha}/pulls")"

          if [ "$(jq 'length' <<<"$prs_json")" -eq 0 ]; then
            echo "No PRs found for commit ${sha}"
            exit 1
          fi

          pr_obj="$(jq -r '[.[] | select(.merged_at != null)][0]' <<<"$prs_json")"
          if [ "$pr_obj" = "null" ] || [ -z "$pr_obj" ]; then
            echo "No merged PR found for commit ${sha}"
            exit 1
          fi

          number="$(jq -r '.number' <<<"$pr_obj")"
          head_sha="$(jq -r '.head.sha' <<<"$pr_obj")"
          head_ref="$(jq -r '.head.ref' <<<"$pr_obj")"
          merge_commit_sha="$(jq -r '.merge_commit_sha // "-" ' <<<"$pr_obj")"

          echo "Using PR #${number} (head: ${head_sha}, merge: ${merge_commit_sha})"
          {
            echo "number=${number}"
            echo "head_sha=${head_sha}"
            echo "head_ref=${head_ref}"
          } >> "$GITHUB_OUTPUT"

      - name: Find successful PR CI run for this commit
        id: run
        env:
          TARGET_WORKFLOW_NAME: "Check Terraform Integrity on PR"
          HEAD_REF: ${{ steps.pr.outputs.head_ref }}
        - name: Find successful PR CI run for this commit (bash)
        id: run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          owner_repo="${{ github.repository }}"
          wf_name='Check Terraform Integrity on PR'
          head_ref='${{ steps.pr.outputs.head_ref }}'

          # Find workflow by name
          wf_list="$(gh api -H 'Accept: application/vnd.github+json' "repos/${owner_repo}/actions/workflows")"
          wf_id="$(jq -r --arg n "$wf_name" '.workflows[] | select(.name==$n) | .id' <<<"$wf_list" | head -n1)"
          if [ -z "${wf_id:-}" ]; then
            echo "Workflow \"$wf_name\" not found"
            exit 1
          fi

          # List runs for pull_request on that branch; newest first by default
          runs="$(gh api -H 'Accept: application/vnd.github+json' \
                 "repos/${owner_repo}/actions/workflows/${wf_id}/runs" \
                 -F event=pull_request -F branch="$head_ref" -F per_page=50)"

          ok="$(jq -r '[.workflow_runs[] | select(.conclusion=="success")] | .[0]' <<<"$runs")"
          if [ "$ok" = "null" ] || [ -z "$ok" ]; then
            echo "No successful PR run found for branch ${head_ref}"
            exit 1
          fi

          run_id="$(jq -r '.id' <<<"$ok")"
          echo "Using run id ${run_id} on $(jq -r '.head_branch' <<<"$ok") ($(jq -r '.head_sha' <<<"$ok"))"
          echo "run_id=${run_id}" >> "$GITHUB_OUTPUT"

      - name: Download all plan artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ steps.run.outputs.run_id }}
          path: ./all_artifacts
          repository: ${{ github.repository }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Create Plugin Cache Dir
        run: mkdir -p $TF_PLUGIN_CACHE_DIR

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Apply all plans
        working-directory: ./all_artifacts
        run: |
          set -e

          # The artifact pattern from the PR workflow is: tfplan-pr-{number}-{name}
          PR_NUM="${{ steps.pr.outputs.number }}"
          PREFIX="tfplan-pr-${PR_NUM}-"

          echo "Looking for artifacts starting with: $PREFIX"

          # Iterate over directories in the download path
          found_any=false
          for dir in */ ; do
            # Remove trailing slash
            dirname=${dir%/}
            
            # Check if this directory name matches our PR pattern
            if [[ "$dirname" == "$PREFIX"* ]]; then
              echo "---------------------------------------------------"
              echo "Processing Artifact: $dirname"
              
              # Enter the artifact directory
              pushd "$dirname" > /dev/null
              
              if [ ! -f "tfplan.bin" ]; then
                echo "::warning::tfplan.bin not found in $dirname, skipping."
                popd > /dev/null
                continue
              fi

              found_any=true

              # Initialize (needed to download providers for apply)
              # We use the lockfile from the plan artifact if available, or just init
              echo "Initializing..."
              terraform init -input=false

              echo "Applying..."
              terraform apply -no-color -input=false tfplan.bin

              popd > /dev/null
              echo "---------------------------------------------------"
            else
              echo "Skipping unrelated artifact: $dirname"
            fi
          done

          if [ "$found_any" = false ]; then
             echo "::error::No matching plan artifacts found for PR #$PR_NUM"
             exit 1
          fi
