name: Terraform Apply on Merge

on:
  push:
    branches: [main]

permissions:
  contents: read
  actions: read
  id-token: write

env:
  TF_IN_AUTOMATION: "true"
  TERRAFORM_VERSION: "1.9.8"
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TF_VAR_region: ${{ secrets.AWS_REGION }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main at the pushed commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Locate merged PR for this commit
        id: pr
        run: |
          # Query API for PRs associated with commit, filter for merged ones, take the first
          PR_DATA=$(gh api "repos/$GITHUB_REPOSITORY/commits/$GITHUB_SHA/pulls" \
            --jq 'map(select(.merged_at != null)) | first')

          if [ -z "$PR_DATA" ] || [ "$PR_DATA" == "null" ]; then
            echo "::error::No merged PR found for commit $GITHUB_SHA"
            exit 1
          fi

          # Extract data using jq
          PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number')
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
          MERGE_SHA=$(echo "$PR_DATA" | jq -r '.merge_commit_sha')

          echo "Using PR #$PR_NUMBER (head: $HEAD_SHA, merge: $MERGE_SHA)"

          # Set outputs
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "head_sha=$HEAD_SHA" >> "$GITHUB_OUTPUT"
          echo "head_ref=$HEAD_REF" >> "$GITHUB_OUTPUT"

      - name: Find successful PR CI run for this commit
        id: run
        env:
          TARGET_WORKFLOW_NAME: "Check Terraform Integrity on PR"
          HEAD_REF: ${{ steps.pr.outputs.head_ref }}
        run: |
          # 1. Find the Workflow ID by name
          # We list all workflows and select the one matching the exact name
          WF_ID=$(gh api "repos/$GITHUB_REPOSITORY/actions/workflows" \
            --jq ".workflows[] | select(.name == \"$TARGET_WORKFLOW_NAME\") | .id")

          if [ -z "$WF_ID" ]; then
            echo "::error::Workflow '$TARGET_WORKFLOW_NAME' not found"
            exit 1
          fi

          echo "Found Workflow ID: $WF_ID"

          # 2. Find the latest successful run for that workflow on the specific branch
          # We filter by event=pull_request, status=success, and branch=HEAD_REF
          RUN_ID=$(gh api "repos/$GITHUB_REPOSITORY/actions/workflows/$WF_ID/runs" \
            -F event=pull_request \
            -F status=success \
            -F branch="$HEAD_REF" \
            --jq '.workflow_runs[0].id')

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" == "null" ]; then
            echo "::error::No successful PR run found for workflow '$TARGET_WORKFLOW_NAME' on branch '$HEAD_REF'"
            exit 1
          fi

          echo "Using run id $RUN_ID"
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-pr-${{ steps.pr.outputs.number }}
          path: ./_pr_plan
          repository: ${{ github.repository }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.run.outputs.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Init backend (defensive)
        run: terraform init -input=false

      - name: Apply the PR plan
        run: |
          set -euo pipefail
          test -f ./_pr_plan/tfplan.bin || { echo "tfplan.bin not found"; exit 1; }
          terraform apply -no-color -input=false ./_pr_plan/tfplan.bin
