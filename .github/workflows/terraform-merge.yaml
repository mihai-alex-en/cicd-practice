name: Terraform Apply on Merge

on:
  push:
    branches: [main]

permissions:
  contents: read
  actions: read
  id-token: write

env:
  TF_IN_AUTOMATION: "true"
  TERRAFORM_VERSION: "1.9.8"
  TF_PLUGIN_CACHE_DIR: /home/runner/.terraform.d/plugin-cache
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TF_VAR_region: ${{ secrets.AWS_REGION }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main at the pushed commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Locate merged PR for this commit
        id: pr
        run: |
          # Query API for PRs associated with commit, filter for merged ones, take the first
          PR_DATA=$(gh api "repos/$GITHUB_REPOSITORY/commits/$GITHUB_SHA/pulls" \
            --jq 'map(select(.merged_at != null)) | first')

          if [ -z "$PR_DATA" ] || [ "$PR_DATA" == "null" ]; then
            echo "::error::No merged PR found for commit $GITHUB_SHA"
            exit 1
          fi

          PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number')
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
          MERGE_SHA=$(echo "$PR_DATA" | jq -r '.merge_commit_sha')

          echo "Using PR #$PR_NUMBER (head: $HEAD_SHA, merge: $MERGE_SHA)"

          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "head_sha=$HEAD_SHA" >> "$GITHUB_OUTPUT"
          echo "head_ref=$HEAD_REF" >> "$GITHUB_OUTPUT"

      - name: Find successful PR CI run for this commit
        id: run
        env:
          TARGET_WORKFLOW_NAME: "Check Terraform Integrity on PR"
          HEAD_REF: ${{ steps.pr.outputs.head_ref }}
        run: |
          # Use 'gh run list' which is cleaner and handles the API details for us
          # We filter by Workflow Name, Branch, Event (pull_request) and Status (success)
          RUN_ID=$(gh run list \
            --workflow "$TARGET_WORKFLOW_NAME" \
            --branch "$HEAD_REF" \
            --event pull_request \
            --status success \
            --limit 1 \
            --json id \
            --jq '.[0].id')

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" == "null" ]; then
            echo "::error::No successful PR run found for workflow '$TARGET_WORKFLOW_NAME' on branch '$HEAD_REF'"
            exit 1
          fi

          echo "Using run id $RUN_ID"
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

      - name: Download all plan artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ steps.run.outputs.run_id }}
          path: ./all_artifacts
          repository: ${{ github.repository }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Create Plugin Cache Dir
        run: mkdir -p $TF_PLUGIN_CACHE_DIR

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Apply all plans
        working-directory: ./all_artifacts
        run: |
          set -e
          
          # The artifact pattern from the PR workflow is: tfplan-pr-{number}-{name}
          PR_NUM="${{ steps.pr.outputs.number }}"
          PREFIX="tfplan-pr-${PR_NUM}-"

          echo "Looking for artifacts starting with: $PREFIX"

          # Iterate over directories in the download path
          found_any=false
          for dir in */ ; do
            # Remove trailing slash
            dirname=${dir%/}
            
            # Check if this directory name matches our PR pattern
            if [[ "$dirname" == "$PREFIX"* ]]; then
              echo "---------------------------------------------------"
              echo "Processing Artifact: $dirname"
              
              # Enter the artifact directory
              pushd "$dirname" > /dev/null
              
              if [ ! -f "tfplan.bin" ]; then
                echo "::warning::tfplan.bin not found in $dirname, skipping."
                popd > /dev/null
                continue
              fi

              found_any=true

              # Initialize (needed to download providers for apply)
              # We use the lockfile from the plan artifact if available, or just init
              echo "Initializing..."
              terraform init -input=false

              echo "Applying..."
              terraform apply -no-color -input=false tfplan.bin

              popd > /dev/null
              echo "---------------------------------------------------"
            else
              echo "Skipping unrelated artifact: $dirname"
            fi
          done

          if [ "$found_any" = false ]; then
             echo "::error::No matching plan artifacts found for PR #$PR_NUM"
             exit 1
          fi