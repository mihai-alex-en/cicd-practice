name: Terraform Apply on Merge

on:
  push:
    branches: [main]

permissions:
  contents: read
  actions: read
  id-token: write

env:
  TF_IN_AUTOMATION: "true"
  TERRAFORM_VERSION: "1.9.8"
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TF_VAR_region: ${{ secrets.AWS_REGION }}

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main at the pushed commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Locate merged PR for this commit
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo, sha} = { owner: context.repo.owner, repo: context.repo.repo, sha: context.sha };
            // PR associated with this merge commit
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({ owner, repo, commit_sha: sha });
            if (!prs.data.length) core.setFailed(`No PR associated with commit ${sha}`);
            const pr = prs.data.find(p => p.merged_at) || prs.data[0];
            core.info(`Using PR #${pr.number}`);
            core.setOutput('number', pr.number);

      - name: Find successful PR CI run for this commit
        id: run
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo, sha} = { owner: context.repo.owner, repo: context.repo.repo, sha: context.sha };

            // Find workflow by name (your PR check workflow)
            const wfs = await github.rest.actions.listRepoWorkflows({ owner, repo });
            const wf = wfs.data.workflows.find(w => w.name === 'Check Terraform Integrity on PR');
            if (!wf) core.setFailed('Workflow "Check Terraform Integrity on PR" not found');

            // List runs for that workflow at this head_sha
            const runs = await github.rest.actions.listWorkflowRuns({
              owner, repo, workflow_id: wf.id, head_sha: sha, event: 'pull_request'
            });

            // Pick the latest successful run
            const ok = runs.data.workflow_runs.find(r => r.conclusion === 'success');
            if (!ok) core.setFailed(`No successful PR run found for ${sha}`);
            core.info(`Using run ${ok.id}`);
            core.setOutput('run_id', ok.id);

      - name: Download plan artifact from PR run
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.sha }}
          path: ./_pr_plan
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          run-id: ${{ steps.run.outputs.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Init backend (defensive)
        run: terraform init -input=false

      - name: Apply the PR plan
        run: |
          set -euo pipefail
          test -f ./_pr_plan/tfplan.bin || { echo "tfplan.bin not found in artifact"; exit 1; }
          terraform apply -no-color -input=false ./_pr_plan/tfplan.bin
