name: Terraform Apply on Merge

on:
  push:
    branches: [main]

permissions:
  contents: read
  actions: read
  id-token: write

env:
  TF_IN_AUTOMATION: "true"
  TERRAFORM_VERSION: "1.9.8"
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TF_VAR_region: ${{ secrets.AWS_REGION }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  REPO: ${{ github.repository }}
  SHA: ${{ github.sha }}
  WF_NAME: "Check Terraform Integrity on PR"

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main at the pushed commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Locate merged PR for this commit
        id: pr
        run: |
          set -euo pipefail
          pr_json=$(gh api "repos/$REPO/commits/$SHA/pulls" --jq 'map(select(.merged_at != null)) | .[0]')
          if [ -z "${pr_json:-}" ] || [ "$pr_json" = "null" ]; then
            echo "No merged PR found for commit $SHA"
            exit 1
          fi
          number=$(jq -r '.number' <<<"$pr_json")
          head_sha=$(jq -r '.head.sha' <<<"$pr_json")
          head_ref=$(jq -r '.head.ref' <<<"$pr_json")
          echo "Using PR #$number (head: $head_sha, ref: $head_ref)"
          {
            echo "number=$number"
            echo "head_sha=$head_sha"
            echo "head_ref=$head_ref"
          } >> "$GITHUB_OUTPUT"

      - name: Find successful PR CI run for this commit
        id: run
        env:
          HEAD_REF: ${{ steps.pr.outputs.head_ref }}
        run: |
          set -euo pipefail
          # Find workflow id by name
          wf_id=$(gh api "repos/$REPO/actions/workflows" --jq ".workflows[] | select(.name==\"$WF_NAME\") | .id")
          if [ -z "${wf_id:-}" ]; then
            echo "Workflow \"$WF_NAME\" not found"
            exit 1
          fi
          # List successful runs for that workflow on the PR head branch
          run_id=$(gh api "repos/$REPO/actions/workflows/$wf_id/runs" \
                     -f event=pull_request -f branch="$HEAD_REF" -f status=success -f per_page=1 \
                     --jq '.workflow_runs[0].id')
          if [ -z "${run_id:-}" ] || [ "$run_id" = "null" ]; then
            echo "No successful PR run found for branch $HEAD_REF"
            exit 1
          fi
          echo "Using run id $run_id"
          echo "run_id=$run_id" >> "$GITHUB_OUTPUT"

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-pr-${{ steps.pr.outputs.number }}
          path: ./_pr_plan
          repository: ${{ github.repository }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.run.outputs.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Init backend (defensive)
        run: terraform init -input=false

      - name: Apply the PR plan
        run: |
          set -euo pipefail
          test -f ./_pr_plan/tfplan.bin || { echo "tfplan.bin not found"; exit 1; }
          terraform apply -no-color -input=false ./_pr_plan/tfplan.bin
