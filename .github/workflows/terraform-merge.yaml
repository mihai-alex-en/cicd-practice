name: Terraform Apply on Merge

on:
  push:
    branches: [main]

permissions:
  contents: read
  actions: read
  pull-requests: read
  id-token: write

env:
  TF_IN_AUTOMATION: "true"
  TERRAFORM_VERSION: "1.9.8"
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TF_VAR_region: ${{ secrets.AWS_REGION }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  REPO: ${{ github.repository }}
  SHA: ${{ github.sha }}
  WF_NAME: "Check Terraform Integrity on PR"

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main at the pushed commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Locate merged PR for this commit
        id: pr
        run: |
          set -euo pipefail
          pr_json="$(gh api \
            -H 'Accept: application/vnd.github+json, application/vnd.github.groot-preview+json' \
            "repos/$REPO/commits/$SHA/pulls" \
            --jq 'map(select(.merged_at != null)) | .[0]' 2>/dev/null || true)"

          # Fallback via search in case of squash/rebase timing
          if [ -z "${pr_json:-}" ] || [ "$pr_json" = "null" ]; then
            pr_number="$(gh api -H 'Accept: application/vnd.github+json' \
              "search/issues?q=repo:$REPO+type:pr+is:merged+$SHA" \
              --jq '.items[0].number' 2>/dev/null || true)"
            if [ -n "${pr_number:-}" ] && [ "$pr_number" != "null" ]; then
              pr_json="$(gh api -H 'Accept: application/vnd.github+json' "repos/$REPO/pulls/$pr_number")"
            fi
          fi

          if [ -z "${pr_json:-}" ] || [ "$pr_json" = "null" ]; then
            echo "No merged PR found for commit $SHA"
            exit 1
          fi

          number="$(jq -r '.number' <<<"$pr_json")"
          head_sha="$(jq -r '.head.sha' <<<"$pr_json")"
          head_ref="$(jq -r '.head.ref' <<<"$pr_json")"
          echo "Using PR #$number (head: $head_sha, ref: $head_ref)"
          {
            echo "number=$number"
            echo "head_sha=$head_sha"
            echo "head_ref=$head_ref"
          } >> "$GITHUB_OUTPUT"

      - name: Find successful PR CI run for this commit
        id: run
        env:
          HEAD_REF: ${{ steps.pr.outputs.head_ref }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          set -euo pipefail
          # Resolve workflow id by name
          wf_id="$(gh api -H 'Accept: application/vnd.github+json' \
            "repos/$REPO/actions/workflows" \
            --jq ".workflows[] | select(.name==\"$WF_NAME\") | .id" 2>/dev/null || true)"
          if [ -z "${wf_id:-}" ]; then
            echo "Workflow \"$WF_NAME\" not found"
            exit 1
          fi

          # Prefer runs explicitly linked to this PR number
          run_id="$(gh api -H 'Accept: application/vnd.github+json' \
            "repos/$REPO/actions/workflows/$wf_id/runs" \
            -f event=pull_request -f per_page=50 \
            --jq ".workflow_runs
                  | map(select(.conclusion==\"success\"))
                  | map(select((.pull_requests // []) | map(.number) | index($PR_NUMBER) != null))
                  | sort_by(.run_number) | reverse | .[0].id" 2>/dev/null || true)"

          # Fallback to head branch filter
          if [ -z "${run_id:-}" ] || [ "$run_id" = "null" ]; then
            run_id="$(gh api -H 'Accept: application/vnd.github+json' \
              "repos/$REPO/actions/workflows/$wf_id/runs" \
              -f event=pull_request -f branch="$HEAD_REF" -f status=success -f per_page=1 \
              --jq '.workflow_runs[0].id' 2>/dev/null || true)"
          fi

          if [ -z "${run_id:-}" ] || [ "$run_id" = "null" ]; then
            echo "No successful PR run found for PR #$PR_NUMBER"
            exit 1
          fi
          echo "Using run id $run_id"
          echo "run_id=$run_id" >> "$GITHUB_OUTPUT"

      - name: Ensure plugin cache dir exists
        run: mkdir -p ~/.terraform.d/plugin-cache

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-pr-${{ steps.pr.outputs.number }}
          path: ./_pr_plan
          repository: ${{ github.repository }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.run.outputs.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Init backend (defensive)
        run: terraform init -input=false

      - name: Apply the PR plan
        run: |
          set -euo pipefail
          test -f ./_pr_plan/tfplan.bin || { echo "tfplan.bin not found"; exit 1; }
          terraform apply -no-color -input=false ./_pr_plan/tfplan.bin
