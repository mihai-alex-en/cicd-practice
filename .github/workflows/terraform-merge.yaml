name: Terraform Apply on Merge

on:
  push:
    branches: [main]

permissions:
  contents: read
  actions: read
  pull-requests: read
  id-token: write

env:
  TERRAFORM_VERSION: "1.9.8"
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TF_VAR_region: ${{ secrets.AWS_REGION }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  REPO: ${{ github.repository }}
  SHA: ${{ github.sha }}
  WF_NAME: "Check Terraform Integrity on PR"

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Find merged PR
        id: pr
        run: |
          pr_number=$(gh api repos/$REPO/commits/$SHA/pulls --jq '.[0].number' 2>/dev/null || true)
          if [ -z "$pr_number" ] || [ "$pr_number" = "null" ]; then
            echo "No PR found for $SHA"
            exit 1
          fi
          echo "PR #$pr_number"
          echo "number=$pr_number" >> "$GITHUB_OUTPUT"

      - name: Find successful workflow run
        id: run
        run: |
          run_id=$(gh api repos/$REPO/actions/runs \
            --jq ".workflow_runs | map(select(.name==\"$WF_NAME\" and .conclusion==\"success\")) | map(select((.pull_requests // []) | any(.number == ${{ steps.pr.outputs.number }}))) | sort_by(.run_number) | reverse | .[0].id" \
            2>/dev/null || true)
          if [ -z "$run_id" ] || [ "$run_id" = "null" ]; then
            echo "No successful run found for PR #${{ steps.pr.outputs.number }}"
            exit 1
          fi
          echo "Using run id $run_id"
          echo "run_id=$run_id" >> "$GITHUB_OUTPUT"

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - run: mkdir -p ~/.terraform.d/plugin-cache

      - uses: actions/download-artifact@v4
        with:
          name: tfplan-pr-${{ steps.pr.outputs.number }}
          path: ./_pr_plan
          repository: ${{ github.repository }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.run.outputs.run_id }}

      - run: terraform init -input=false

      - name: Apply the plan
        run: |
          test -f ./_pr_plan/tfplan.bin || { echo "tfplan.bin not found"; exit 1; }
          terraform apply -no-color -input=false ./_pr_plan/tfplan.bin
