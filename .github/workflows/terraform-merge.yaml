name: Terraform Apply on Merge

on:
  push:
    branches: [main]

permissions:
  contents: read
  actions: read
  id-token: write

env:
  TF_IN_AUTOMATION: "true"
  TERRAFORM_VERSION: "1.9.8"
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TF_VAR_region: ${{ secrets.AWS_REGION }}

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main at the pushed commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Locate merged PR for this commit
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const sha = context.sha;
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner, repo, commit_sha: sha
            });
            const pr = prs.data.find(p => p.merged_at);
            if (!pr) core.setFailed(`No merged PR found for commit ${sha}`);
            core.info(`Using PR #${pr.number} (head: ${pr.head.sha}, merge: ${pr.merge_commit_sha})`);
            core.setOutput('number', pr.number);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('head_ref', pr.head.ref);

      - name: Find successful PR CI run for this commit
        id: run
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            // Find your PR workflow by NAME
            const wfList = await github.rest.actions.listRepoWorkflows({ owner, repo });
            const wf = wfList.data.workflows.find(w => w.name === 'Check Terraform Integrity on PR');
            if (!wf) core.setFailed('Workflow "Check Terraform Integrity on PR" not found');

            // List recent runs for that workflow on the PR head branch, event pull_request
            const runs = await github.rest.actions.listWorkflowRuns({
              owner, repo, workflow_id: wf.id,
              event: 'pull_request',
              branch: core.getInput('branch') || undefined   // not used; we'll filter below
            });

            // Filter to runs created for this PR head ref and take the latest success
            const headRef = '${{ steps.pr.outputs.head_ref }}';
            const candidates = runs.data.workflow_runs
              .filter(r => r.head_branch === headRef && r.conclusion === 'success');

            if (!candidates.length) core.setFailed('No successful PR run found for the merged PR');
            const ok = candidates[0]; // newest first
            core.info(`Using run id ${ok.id} on ${ok.head_branch} (${ok.head_sha})`);
            core.setOutput('run_id', ok.id);

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-pr-${{ steps.pr.outputs.number }}
          path: ./_pr_plan
          repository: ${{ github.repository }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.run.outputs.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Init backend (defensive)
        run: terraform init -input=false

      - name: Apply the PR plan
        run: |
          set -euo pipefail
          test -f ./_pr_plan/tfplan.bin || { echo "tfplan.bin not found"; exit 1; }
          terraform apply -no-color -input=false ./_pr_plan/tfplan.bin
