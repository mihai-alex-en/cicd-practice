name: Check Terraform Integrity on PR

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "*.tf"
      - "*.tfvars"
      - ".terraform.lock.hcl"
      - "modules/**"

permissions:
  contents: read
  pull-requests: write
  actions: read
  id-token: write

concurrency:
  group: terraform-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  TF_IN_AUTOMATION: "true"
  TF_VAR_region: ${{ secrets.AWS_REGION }}
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TERRAFORM_VERSION: 1.9.8

jobs:
  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Terraform format check
        run: terraform fmt -check -recursive

  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checking out the PR reference
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Terraform init (no backend)
        run: terraform init -backend=false -input=false
      - name: Terraform validate
        run: terraform validate

  plan:
    needs: [validate, fmt]
    runs-on: ubuntu-latest
    steps:
      - name: Checking out the PR reference
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
      - name: Caching Terraform providers
        uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: tf-plugins-${{ runner.os }}-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            tf-plugins-${{ runner.os }}-
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Terraform init
        run: terraform init -input=false
      - name: Terraform plan
        id: plan
        run: |
          set -euo pipefail
          terraform plan -no-color -out=tfplan.bin -input=false
          terraform show -no-color tfplan.bin > tfplan.txt
      - name: Upload plan artifact
        if: steps.plan.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-pr-${{ github.event.pull_request.number }}
          path: |
            tfplan.bin
            tfplan.txt
          retention-days: 14
