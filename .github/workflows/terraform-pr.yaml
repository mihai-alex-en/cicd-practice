name: Check Terraform Integrity on PR

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - ".terraform.lock.hcl"
      - "modules/**"

permissions:
  contents: read
  actions: read

concurrency:
  group: terraform-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  TF_IN_AUTOMATION: "true"
  TF_PLUGIN_CACHE_DIR: /home/runner/.terraform.d/plugin-cache
  TERRAFORM_VERSION: "1.9.8"

defaults:
  run:
    shell: bash

jobs:
  discover:
    name: Discover terraform roots
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
          fetch-depth: 0
      - id: roots
        run: |
          mapfile -t roots < <(git ls-files | grep -E '\.tf$' | xargs -I{} dirname {} | sort -u)
          printf '%s\n' "${roots[@]}" > /tmp/roots.txt
      - id: set-matrix
        run: |
          # Create a JSON object with a 'dir' key containing the list of directories
          MATRIX_JSON=$(jq -cRn '{dir: [inputs | select(length>0)]}' < /tmp/roots.txt)
          echo "matrix=$MATRIX_JSON" >> "$GITHUB_OUTPUT"

  fmt:
    name: terraform fmt
    runs-on: ubuntu-latest
    needs: discover
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Terraform format check
        working-directory: ${{ matrix.dir }}
        run: terraform fmt -check -recursive

  validate:
    name: terraform validate
    runs-on: ubuntu-latest
    needs: discover
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Create Plugin Cache Dir
        run: mkdir -p $TF_PLUGIN_CACHE_DIR
      - name: Cache provider plugins
        uses: actions/cache@v4
        with:
          path: ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: tf-plugins-${{ runner.os }}-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            tf-plugins-${{ runner.os }}-
      - name: Terraform init (no backend, verify lockfile)
        working-directory: ${{ matrix.dir }}
        run: terraform init -backend=false -input=false
      - name: Terraform validate
        working-directory: ${{ matrix.dir }}
        run: terraform validate

  lint:
    name: lint (tflint + tfsec)
    runs-on: ubuntu-latest
    needs: discover
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
      - uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.53.0
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - name: tflint
        run: tflint --recursive --format=compact
      - name: tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          additional_args: --format=sarif --out=results.sarif
          soft_fail: true
      - name: Upload tfsec SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: success() || failure()
        with:
          sarif_file: results.sarif

  plan:
    name: terraform plan
    runs-on: ubuntu-latest
    needs: [discover, fmt, validate, lint]
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
          persist-credentials: false
      - name: Create Plugin Cache Dir
        run: mkdir -p $TF_PLUGIN_CACHE_DIR
      - uses: actions/cache@v4
        name: Cache provider plugins
        with:
          path: ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: tf-plugins-${{ runner.os }}-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            tf-plugins-${{ runner.os }}-

      - uses: actions/cache@v4
        name: Cache .terraform dirs
        with:
          path: ${{ matrix.dir }}/.terraform
          key: tf-dir-${{ runner.os }}-${{ matrix.dir }}-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            tf-dir-${{ runner.os }}-${{ matrix.dir }}-

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: gha-terraform-plan-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform init (verify lockfile)
        working-directory: ${{ matrix.dir }}
        run: terraform init -input=false -lockfile=readonly

      - name: Terraform plan
        id: plan
        working-directory: ${{ matrix.dir }}
        run: |
          set -euo pipefail
          terraform plan -no-color -input=false -detailed-exitcode -out=tfplan.bin || ec=$?
          terraform show -no-color -json tfplan.bin > tfplan.json || true
          terraform show -no-color tfplan.bin > tfplan.txt || true
          echo "exitcode=${ec:-0}" >> "$GITHUB_OUTPUT"

      - name: Sanitize Artifact Name
        id: art_name
        run: |
           if [ "${{ matrix.dir }}" == "." ]; then
             echo "name=root" >> "$GITHUB_OUTPUT"
           else
             CLEAN_NAME=$(echo "${{ matrix.dir }}" | sed 's/\//-/g')
             echo "name=${CLEAN_NAME}" >> "$GITHUB_OUTPUT"
           fi

      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-pr-${{ github.event.pull_request.number }}-${{ steps.art_name.outputs.name }}
          path: |
            ${{ matrix.dir }}/tfplan.bin
            ${{ matrix.dir }}/tfplan.txt
            ${{ matrix.dir }}/tfplan.json
          retention-days: 14

      - name: Summarize plan
        if: always()
        run: |
          echo "## Terraform plan for \`${{ matrix.dir }}\`" >> "$GITHUB_STEP_SUMMARY"
          if [[ "${{ steps.plan.outputs.exitcode }}" == "2" ]]; then
            echo "- Changes detected." >> "$GITHUB_STEP_SUMMARY"
          elif [[ "${{ steps.plan.outputs.exitcode }}" == "0" ]]; then
            echo "- No changes." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Plan failed (see logs)." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Comment plan on PR
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          header: plan-${{ matrix.dir }}
          message: |
            **Terraform plan for `${{ matrix.dir }}`**
            Exit code: ${{ steps.plan.outputs.exitcode }}
            Artifact: `tfplan-pr-${{ github.event.pull_request.number }}-${{ steps.art_name.outputs.name }}`