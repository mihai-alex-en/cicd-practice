name: Terraform Manual Ops

on:
  workflow_dispatch:
    inputs:
      operation:
        description: "Select operation to run"
        type: choice
        options:
          - fmt
          - validate
          - plan
          - apply
          - destroy
          - validate+plan
          - plan+apply
          - validate+plan+apply
        default: fmt
      mode:
        description: "apply mode (use_artifact = apply tfplan-<sha>; replan = create new plan before apply)"
        type: choice
        options:
          - use_artifact
          - replan
        default: use_artifact
      sha:
        description: "Commit SHA (leave empty for latest main)"
        type: string
        default: ""
      allow_replan_if_missing:
        description: "Replan if artifact missing (for mode=use_artifact)"
        type: boolean
        default: false
      auto_approve:
        description: "Automatically approve apply/destroy"
        type: boolean
        default: true
      workspace:
        description: "Terraform workspace (optional)"
        type: string
        default: ""
      var_file:
        description: "Optional -var-file (e.g. prod.tfvars)"
        type: string
        default: ""

permissions:
  contents: read
  actions: read
  id-token: write

env:
  TF_IN_AUTOMATION: "true"
  TF_PLUGIN_CACHE_DIR: /home/runner/.terraform.d/plugin-cache
  TF_VAR_region: ${{ secrets.AWS_REGION }}
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  resolve:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.getsha.outputs.sha }}
    steps:
      - id: getsha
        run: |
          if [ -n "${{ inputs.sha }}" ]; then
            echo "sha=${{ inputs.sha }}" >> "$GITHUB_OUTPUT"
          else
            SHA=$(git ls-remote https://github.com/${{ github.repository }} refs/heads/main | cut -f1)
            echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          fi

  fmt:
    if: ${{ inputs.operation == 'fmt' }}
    runs-on: ubuntu-latest
    needs: resolve
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.sha }}
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8
      - name: terraform fmt
        run: terraform fmt -check -recursive

  validate:
    if: ${{ contains(inputs.operation, 'validate') }}
    runs-on: ubuntu-latest
    needs: resolve
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.sha }}
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8
      - name: Setup plugin cache
        run: mkdir -p $TF_PLUGIN_CACHE_DIR
      - uses: actions/cache@v4
        with:
          path: ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: tf-plugins-${{ runner.os }}-${{ hashFiles('**/.terraform.lock.hcl') }}
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: terraform init
        run: terraform init -input=false -no-color
      - name: terraform validate
        run: terraform validate -no-color

  plan:
    if: ${{ contains(inputs.operation, 'plan') }}
    runs-on: ubuntu-latest
    needs: [resolve]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.sha }}
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8
      - name: Setup plugin cache
        run: mkdir -p $TF_PLUGIN_CACHE_DIR
      - uses: actions/cache@v4
        with:
          path: ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: tf-plugins-${{ runner.os }}-${{ hashFiles('**/.terraform.lock.hcl') }}
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: terraform init
        run: terraform init -input=false -no-color
      - name: Select workspace
        if: ${{ inputs.workspace != '' }}
        run: terraform workspace select "${{ inputs.workspace }}" || terraform workspace new "${{ inputs.workspace }}"
      - name: terraform plan
        run: |
          EXTRA=()
          if [ -n "${{ inputs.var_file }}" ]; then
            EXTRA+=("-var-file=${{ inputs.var_file }}")
          fi
          terraform plan -no-color -compact-warnings -input=false -out=tfplan.bin "${EXTRA[@]}"
          terraform show -no-color tfplan.bin > tfplan.txt
      - uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ needs.resolve.outputs.sha }}
          path: |
            tfplan.bin
            tfplan.txt
          retention-days: 14

  apply:
    if: ${{ contains(inputs.operation, 'apply') }}
    runs-on: ubuntu-latest
    needs: [resolve]
    environment: prod
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.sha }}
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: terraform init
        run: terraform init -input=false -no-color

      - name: Download plan artifact
        id: fetch_plan
        if: ${{ inputs.mode == 'use_artifact' }}
        run: |
          set -euo pipefail
          NAME="tfplan-${{ needs.resolve.outputs.sha }}"
          echo "${{ github.token }}" | gh auth login --with-token
          FOUND=""
          for RUN_ID in $(gh api repos/${{ github.repository }}/actions/runs --paginate --jq '.workflow_runs[].id'); do
            ART_ID=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts --jq ".artifacts[]? | select(.name==\"${NAME}\") | .id" || true)
            if [ -n "$ART_ID" ]; then
              gh api repos/${{ github.repository }}/actions/artifacts/$ART_ID/zip > artifact.zip
              unzip -o artifact.zip
              FOUND="true"
              break
            fi
          done
          echo "artifact_found=$FOUND" >> $GITHUB_OUTPUT

      - name: Replan if missing and allowed
        if: ${{ inputs.mode == 'use_artifact' && steps.fetch_plan.outputs.artifact_found != 'true' && inputs.allow_replan_if_missing }}
        run: terraform plan -input=false -no-color -out=tfplan.bin

      - name: Fail if missing and not allowed
        if: ${{ inputs.mode == 'use_artifact' && steps.fetch_plan.outputs.artifact_found != 'true' && !inputs.allow_replan_if_missing }}
        run: |
          echo "::error::No plan artifact found, and replan not allowed"
          exit 1

      - name: terraform apply
        run: |
          FLAGS=(-input=false -no-color -lock=true -lock-timeout=10m -parallelism=10)
          if [ "${{ inputs.auto_approve }}" = "true" ]; then
            FLAGS+=(-auto-approve)
          fi
          terraform apply "${FLAGS[@]}" tfplan.bin

  destroy:
    if: ${{ inputs.operation == 'destroy' }}
    runs-on: ubuntu-latest
    needs: [resolve]
    environment: prod
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.sha }}
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: terraform init
        run: terraform init -input=false -no-color
      - name: Select workspace
        if: ${{ inputs.workspace != '' }}
        run: terraform workspace select "${{ inputs.workspace }}" || terraform workspace new "${{ inputs.workspace }}"
      - name: terraform destroy
        run: |
          FLAGS=(-input=false -no-color -lock=true -lock-timeout=10m -parallelism=10)
          if [ -n "${{ inputs.var_file }}" ]; then
            FLAGS+=("-var-file=${{ inputs.var_file }}")
          fi
          if [ "${{ inputs.auto_approve }}" = "true" ]; then
            FLAGS+=("-auto-approve")
          fi
          terraform destroy "${FLAGS[@]}"
