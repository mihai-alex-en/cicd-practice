name: Terraform Manual Ops

on:
  workflow_dispatch:
    inputs:
      jobs:
        description: "Comma-separated jobs to run: fmt, validate, plan, apply, destroy"
        type: string
        default: "fmt"
      mode:
        description: "use_artifact = apply with tfplan-<sha>; replan = create new plan before apply"
        type: choice
        options:
          - use_artifact
          - replan
        default: use_artifact
      sha:
        description: "Commit SHA to target (blank = HEAD of main)"
        type: string
        default: ""
      allow_replan_if_missing:
        description: "If mode=use_artifact and plan not found, replan"
        type: boolean
        default: false
      auto_approve:
        description: "Pass -auto-approve to terraform apply/destroy"
        type: boolean
        default: true
      workspace:
        description: "Terraform workspace to use (blank = default)"
        type: string
        default: ""
      var_file:
        description: "Optional -var-file (e.g. prod.tfvars)"
        type: string
        default: ""

permissions:
  contents: read
  actions: read
  id-token: write

env:
  TF_IN_AUTOMATION: "true"
  TF_VAR_region: ${{ secrets.AWS_REGION }}
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  resolve:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.out.outputs.sha }}
    steps:
      - id: out
        run: |
          if [ -n "${{ github.event.inputs.sha }}" ]; then
            SHA="${{ github.event.inputs.sha }}"
          else
            SHA=$(git ls-remote https://github.com/${{ github.repository }} refs/heads/main | cut -f1)
          fi
          echo "sha=$SHA" >> $GITHUB_OUTPUT

  fmt:
    if: contains(github.event.inputs.jobs, 'fmt')
    runs-on: ubuntu-latest
    needs: resolve
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.sha }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8
      - name: terraform fmt -check
        run: terraform fmt -check -recursive

  validate:
    if: contains(github.event.inputs.jobs, 'validate')
    runs-on: ubuntu-latest
    needs: resolve
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.sha }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: terraform init
        run: terraform init -input=false
      - name: terraform validate
        run: terraform validate

  plan:
    if: contains(github.event.inputs.jobs, 'plan')
    runs-on: ubuntu-latest
    needs: resolve
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.sha }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: terraform init
        run: terraform init -input=false
      - name: terraform plan
        run: |
          terraform plan -out=tfplan.bin -input=false
          terraform show -no-color tfplan.bin > tfplan.txt
      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ needs.resolve.outputs.sha }}
          path: |
            tfplan.bin
            tfplan.txt
          retention-days: 14

  apply:
    if: contains(github.event.inputs.jobs, 'apply')
    runs-on: ubuntu-latest
    needs: resolve
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.sha }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: terraform init
        run: terraform init -input=false

      - name: Download plan artifact
        id: fetch_plan
        if: startsWith(github.event.inputs.mode, 'use_artifact')
        shell: bash
        run: |
          set -euo pipefail
          NAME="tfplan-${{ needs.resolve.outputs.sha }}"
          echo "${{ github.token }}" | gh auth login --with-token
          FOUND=""
          for RUN_ID in $(gh api repos/${{ github.repository }}/actions/runs --paginate --jq '.workflow_runs[].id'); do
            ART_ID=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts --jq ".artifacts[]? | select(.name==\"${NAME}\") | .id" || true)
            if [ -n "$ART_ID" ]; then
              gh api repos/${{ github.repository }}/actions/artifacts/$ART_ID/zip > artifact.zip
              unzip -o artifact.zip
              FOUND="yes"
              break
            fi
          done
          if [ -n "$FOUND" ]; then
            echo "artifact_found=true" >> $GITHUB_OUTPUT
          else
            echo "artifact_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Replan because artifact missing and allowed
        if: startsWith(github.event.inputs.mode, 'use_artifact') && steps.fetch_plan.outputs.artifact_found != 'true' && github.event.inputs.allow_replan_if_missing == 'true'
        run: |
          terraform plan -out=tfplan.bin -input=false
          terraform show -no-color tfplan.bin > tfplan.txt

      - name: Create fresh plan (mode=replan)
        if: github.event.inputs.mode == 'replan'
        run: |
          terraform plan -out=tfplan.bin -input=false
          terraform show -no-color tfplan.bin > tfplan.txt

      - name: Fail if artifact missing and replan not allowed
        if: startsWith(github.event.inputs.mode, 'use_artifact') && steps.fetch_plan.outputs.artifact_found != 'true' && github.event.inputs.allow_replan_if_missing != 'true'
        run: |
          echo "No matching plan artifact found and replan not allowed."
          exit 1

      - name: terraform apply
        run: terraform apply ${{ github.event.inputs.auto_approve == 'true' && '-auto-approve' || '' }} tfplan.bin

  destroy: # <-- added
    if: contains(github.event.inputs.jobs, 'destroy')
    runs-on: ubuntu-latest
    needs: resolve
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.sha }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: terraform init
        run: terraform init -input=false

      - name: Select workspace (optional)
        if: ${{ github.event.inputs.workspace != '' }}
        run: terraform workspace select "${{ github.event.inputs.workspace }}" || terraform workspace new "${{ github.event.inputs.workspace }}"

      - name: terraform destroy
        run: |
          set -euo pipefail
          EXTRA_ARGS=()
          if [ -n "${{ github.event.inputs.var_file }}" ]; then
            EXTRA_ARGS+=("-var-file=${{ github.event.inputs.var_file }}")
          fi
          if [ "${{ github.event.inputs.auto_approve }}" = "true" ]; then
            EXTRA_ARGS+=("-auto-approve")
          fi
          EXTRA_ARGS+=("-lock=true" "-lock-timeout=10m" "-parallelism=10")
          terraform destroy -input=false "${EXTRA_ARGS[@]}"
